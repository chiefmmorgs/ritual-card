<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Ritualist ID Card Generator</title>
    <style>
        :root {
            --bg-dark-start: #0A0B0C;
            --bg-dark-end: #151A1E;
            --text-primary: #FFFFFF;
            --text-secondary: #8FA6B8;
            --card-bg: #1A1D23;
            --pledged-color: #B7FF3C;
            --border-subtle: #2A2D35;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(180deg, var(--bg-dark-start) 0%, var(--bg-dark-end) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.01) 35px, rgba(255,255,255,.01) 70px),
                repeating-linear-gradient(-45deg, transparent, transparent 35px, rgba(255,255,255,.01) 35px, rgba(255,255,255,.01) 70px);
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            opacity: 0.08;
            pointer-events: none;
            z-index: 1;
        }

        @media (prefers-reduced-motion: reduce) {
            body::after {
                animation: none !important;
            }
            .pledged-chip {
                animation: none !important;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 2;
        }

        header {
            text-align: center;
            margin-bottom: 60px;
        }

        h1 {
            font-size: 3rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            margin-bottom: 16px;
            text-transform: uppercase;
        }

        .subtitle {
            font-size: 1.5rem;
            letter-spacing: 0.15em;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .tagline {
            font-size: 1rem;
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .social-cta {
            margin-top: 20px;
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .social-cta a {
            color: #1DA1F2;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s ease;
        }

        .social-cta a:hover {
            color: #7FBFFF;
            text-decoration: underline;
        }

        #previewStage {
            margin-bottom: 40px;
            display: flex;
            justify-content: center;
        }

        #cardCanvas {
            max-width: 100%;
            height: auto;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5), inset 0 0 40px rgba(255,255,255,0.03);
        }

        .controls {
            background: rgba(26, 29, 35, 0.6);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 32px;
            backdrop-filter: blur(10px);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        input[type="text"],
        input[type="date"],
        select {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: var(--pledged-color);
            box-shadow: 0 0 0 3px rgba(183, 255, 60, 0.1);
        }

        select {
            cursor: pointer;
        }

        input[type="file"] {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
        }

        input[type="file"]::file-selector-button {
            background: var(--pledged-color);
            color: #000;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 12px;
        }

        .button-group {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        button {
            background: var(--pledged-color);
            color: #000;
            border: none;
            border-radius: 8px;
            padding: 14px 32px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(183, 255, 60, 0.3);
        }

        button:focus {
            outline: 3px solid rgba(183, 255, 60, 0.5);
            outline-offset: 2px;
        }

        a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            transition: color 0.3s ease;
        }

        a:hover {
            color: var(--pledged-color);
        }

        footer {
            text-align: center;
            margin-top: 60px;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            opacity: 0.6;
        }

        .made-by-logo {
            text-align: left;
            padding-left: 20px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .made-by-logo img {
            width: 180px;
            height: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Ritualist ID Card Generator</h1>
            <div class="subtitle">LET THE RITUAL BEGIN</div>
            <div class="tagline">Generate your Ritualist identity for community use</div>
            <div class="social-cta">
                Share your ID on <a href="https://x.com/chief_mmorgs" target="_blank" rel="noopener noreferrer">@chief_mmorgs</a> ùïè
            </div>
        </header>

        <div id="previewStage">
            <canvas id="cardCanvas" width="2400" height="900"></canvas>
        </div>

        <div class="controls">
            <div class="form-grid">
                <div class="form-group">
                    <label for="nameInput">Name</label>
                    <input type="text" id="nameInput" placeholder="e.g. chiefmmorgs" value="chiefmmorgs">
                </div>

                <div class="form-group">
                    <label for="coreRoleSelect">Core Role</label>
                    <select id="coreRoleSelect">
                        <option value="mage">Mage</option>
                        <option value="ritualist" selected>Ritualist</option>
                        <option value="ritualist ascendant">Ritualist Ascendant</option>
                        <option value="node runner">Node Runner</option>
                        <option value="limbo">Limbo</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="auraRoleSelect">Aura Role</label>
                    <select id="auraRoleSelect">
                        <option value="initiate">Initiate</option>
                        <option value="blessed">Blessed</option>
                        <option value="cursed">Cursed</option>
                        <option value="harmonic" selected>Harmonic</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="portfolioInput">Portfolio (Optional)</label>
                    <input type="text" id="portfolioInput" placeholder="e.g. Educator" value="Educator">
                </div>

                <div class="form-group">
                    <label for="dateInput">Date of Join</label>
                    <input type="date" id="dateInput">
                </div>

                <div class="form-group">
                    <label for="photoInput">Upload Photo</label>
                    <input type="file" id="photoInput" accept="image/*">
                </div>
            </div>

            <div class="button-group">
                <button id="downloadBtn">Download PNG</button>
                <a href="#" id="resetLink">Reset</a>
                <a href="#" id="exportSheetLink">Export 2√ó Sheet</a>
            </div>
        </div>

        <div class="made-by-logo">
            <img src="attached_assets/chiefmmorgs_extrabold_transparent_1759657966154.png" alt="Made by">
        </div>
        
        <footer>
            For entertainment and community use only
        </footer>
    </div>

    <script>
        const state = {
            name: 'chiefmmorgs',
            coreRole: 'ritualist',
            auraRole: 'harmonic',
            pledged: true,
            portfolio: 'Educator',
            dateISO: new Date().toISOString().split('T')[0],
            avatar: null
        };

        const colorSchemes = {
            'mage-harmonic': { bgStart: '#0A1F35', bgEnd: '#051020', textColor: '#5A9BD4', titleColor: '#7FBFFF' },
            'mage-cursed': { bgStart: '#1F0A35', bgEnd: '#100520', textColor: '#9B5CF6', titleColor: '#C49FFF' },
            'mage-blessed': { bgStart: '#3A2510', bgEnd: '#1D1208', textColor: '#FFB84D', titleColor: '#FFD98F' },
            'mage-initiate': { bgStart: '#1A1A1E', bgEnd: '#0D0D10', textColor: '#8FA3B8', titleColor: '#B8CCD9' },
            
            'ritualist-harmonic': { bgStart: '#001F3F', bgEnd: '#000A1A', textColor: '#4A90E2', titleColor: '#7FBFFF' },
            'ritualist-cursed': { bgStart: '#3F001F', bgEnd: '#1A000A', textColor: '#E24A90', titleColor: '#FF7FBF' },
            'ritualist-blessed': { bgStart: '#3D2814', bgEnd: '#1F1408', textColor: '#FFB84D', titleColor: '#FFD966' },
            'ritualist-initiate': { bgStart: '#2A2A30', bgEnd: '#15151A', textColor: '#A0A8B0', titleColor: '#D0D8E0' },
            
            'ritualist ascendant-harmonic': { bgStart: '#1D3354', bgEnd: '#0E1A2A', textColor: '#7AABF0', titleColor: '#9FC9FF' },
            'ritualist ascendant-cursed': { bgStart: '#331D54', bgEnd: '#1A0E2A', textColor: '#9B7AF0', titleColor: '#C4A9FF' },
            'ritualist ascendant-blessed': { bgStart: '#6B4F28', bgEnd: '#352814', textColor: '#FFEB99', titleColor: '#FFF7D6' },
            'ritualist ascendant-initiate': { bgStart: '#222226', bgEnd: '#111113', textColor: '#99AEC3', titleColor: '#C2D7EC' },
            
            'node runner-harmonic': { bgStart: '#0D2E3F', bgEnd: '#061722', textColor: '#4FB3D6', titleColor: '#74D4FF' },
            'node runner-cursed': { bgStart: '#2E0D3F', bgEnd: '#170622', textColor: '#B34FD6', titleColor: '#D974FF' },
            'node runner-blessed': { bgStart: '#3F2E0D', bgEnd: '#221706', textColor: '#D6B34F', titleColor: '#FFD974' },
            'node runner-initiate': { bgStart: '#1C1C20', bgEnd: '#0E0E10', textColor: '#8E9EB3', titleColor: '#B3C3D8' },
            
            'limbo-harmonic': { bgStart: '#242938', bgEnd: '#12141C', textColor: '#7D8FBD', titleColor: '#A2B4E2' },
            'limbo-cursed': { bgStart: '#382438', bgEnd: '#1C121C', textColor: '#BD7D8F', titleColor: '#E2A2B4' },
            'limbo-blessed': { bgStart: '#383324', bgEnd: '#1C1912', textColor: '#BDA77D', titleColor: '#E2C8A2' },
            'limbo-initiate': { bgStart: '#20202A', bgEnd: '#101015', textColor: '#8998AD', titleColor: '#AEB7CC' }
        };

        const ritualLogoImage = 'attached_assets/image_1759656540647.png';
        const madeByLogoImage = 'attached_assets/chiefmmorgs_extrabold_transparent_1759657966154.png';
        const magePixelImage = 'attached_assets/image_1759666446461.png';
        
        const logoImg = new Image();
        logoImg.src = ritualLogoImage;
        
        const madeByImg = new Image();
        madeByImg.src = madeByLogoImage;
        
        const magePixelImg = new Image();
        magePixelImg.src = magePixelImage;

        const canvas = document.getElementById('cardCanvas');
        const ctx = canvas.getContext('2d');

        function resolveTheme(core, aura) {
            const key = `${core}-${aura}`;
            const scheme = colorSchemes[key] || colorSchemes['ritualist-harmonic'];
            return {
                bgStart: scheme.bgStart,
                bgEnd: scheme.bgEnd,
                textColor: scheme.textColor,
                titleColor: scheme.titleColor,
                isNodeRunner: core === 'node runner',
                isMage: core === 'mage',
                isRitualist: core === 'ritualist',
                isRitualistAscendant: core === 'ritualist ascendant'
            };
        }

        function drawPlasmaBackground(ctx, theme, width, height, timestamp = 0) {
            const gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, theme.bgStart);
            gradient.addColorStop(1, theme.bgEnd);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);

            const waveGradient = ctx.createRadialGradient(width * 0.5, height * 0.5, 0, width * 0.5, height * 0.5, width * 0.6);
            waveGradient.addColorStop(0, `${theme.textColor}40`);
            waveGradient.addColorStop(0.5, `${theme.textColor}10`);
            waveGradient.addColorStop(1, 'rgba(0,0,0,0.3)');
            ctx.fillStyle = waveGradient;
            ctx.fillRect(0, 0, width, height);

            for (let i = 0; i < 3; i++) {
                const offset = (timestamp * 0.0005 + i * 0.3) % 1;
                const waveY = height * 0.5 + Math.sin(offset * Math.PI * 2) * height * 0.2;
                const waveGrad = ctx.createLinearGradient(0, waveY - 100, 0, waveY + 100);
                waveGrad.addColorStop(0, `${theme.textColor}00`);
                waveGrad.addColorStop(0.5, `${theme.textColor}30`);
                waveGrad.addColorStop(1, `${theme.textColor}00`);
                ctx.fillStyle = waveGrad;
                ctx.fillRect(0, waveY - 100, width, 200);
            }
        }

        function applyAuraTint(ctx, theme, width, height) {
            const vigGrad = ctx.createRadialGradient(width / 2, height / 2, 0, width / 2, height / 2, width * 0.7);
            vigGrad.addColorStop(0, 'rgba(0,0,0,0)');
            vigGrad.addColorStop(1, 'rgba(0,0,0,0.4)');
            ctx.fillStyle = vigGrad;
            ctx.fillRect(0, 0, width, height);
        }

        function drawNodeRunnerEffects(ctx, width, height, theme, timestamp = 0) {
            const terminalLines = [
                'Estimated total gas used for script: 863268',
                'Estimated amount required: 0.000038368728380808 ETH',
                '============================',
                '##### base',
                '‚úÖ [Success]Hash: 0xa514b85f8b3e7db7e21b97e4df8db2b3ae9f7ecec1ea4279ea7aadreb5a8ad5',
                'Contract Address: 0xC115fe0Ba97B66eB482B5d27e60a90a0Dc119e8e',
                'Block: 15712564',
                'Paid: 0.000015120927755424 ETH (664253 gas * 0.022763808 gwei)',
                '‚úÖ Sequence #1 on base | Total Paid: 0.000015120927755424 ETH',
                '============================',
                'ONCHAIN EXECUTION COMPLETE & SUCCESSFUL.',
                'Transactions saved to: /root/projects/hello-world/contracts',
                'make[1]: Leaving directory \'/root/projects/hello-world/contracts\''
            ];

            ctx.save();
            ctx.font = '20px monospace';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.globalAlpha = 0.15;
            
            const lineHeight = 32;
            const startY = 100;
            
            terminalLines.forEach((line, index) => {
                const y = startY + (index * lineHeight);
                if (line.includes('‚úÖ') || line.includes('Success')) {
                    ctx.fillStyle = '#00ff00';
                } else if (line.includes('Hash:') || line.includes('Contract')) {
                    ctx.fillStyle = theme.textColor;
                } else {
                    ctx.fillStyle = '#ffffff';
                }
                ctx.fillText(line, 120, y);
            });
            
            ctx.restore();

            ctx.strokeStyle = '#1B2026';
            ctx.lineWidth = 2;
            ctx.globalAlpha = 0.3;

            const gridSize = 80;
            for (let x = 0; x < width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            for (let y = 0; y < height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }

            const scanlineY = ((timestamp * 0.0003) % 1) * height;
            ctx.globalAlpha = 0.06;
            const scanGrad = ctx.createLinearGradient(0, scanlineY - 40, 0, scanlineY + 40);
            scanGrad.addColorStop(0, `${theme.textColor}00`);
            scanGrad.addColorStop(0.5, `${theme.textColor}FF`);
            scanGrad.addColorStop(1, `${theme.textColor}00`);
            ctx.fillStyle = scanGrad;
            ctx.fillRect(0, scanlineY - 40, width, 80);

            ctx.globalAlpha = 1;
        }

        function drawRitualistEffects(ctx, width, height, theme, timestamp = 0) {
            const discordChannels = [
                'üì¢ | announcements',
                'üéä | events',
                'üìú | rules',
                '',
                'Blessings of Syn',
                'üî∑ | 21-day-announcements',
                'üî∑ | pledge',
                'üî∑ | ‚ô¶‚ô¶',
                'üî∑ | prompt-a-palooza',
                '',
                'Ritual Community',
                'üòä | gritual',
                'ü§ù | ascension',
                'üí¨ | community',
                'üì¶ | contributions',
                'üôè | confessions',
                'üòÇ | memes',
                'üé® | vestibule',
                'üö© | report',
                'üò∑ | rank'
            ];

            ctx.save();
            ctx.font = '22px sans-serif';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.globalAlpha = 0.12;
            
            const lineHeight = 35;
            const startY = 80;
            const startX = 80;
            
            discordChannels.forEach((channel, index) => {
                const y = startY + (index * lineHeight);
                if (channel === '' || channel === 'Blessings of Syn' || channel === 'Ritual Community') {
                    ctx.font = 'bold 22px sans-serif';
                    ctx.fillStyle = theme.titleColor;
                } else {
                    ctx.font = '22px sans-serif';
                    ctx.fillStyle = '#ffffff';
                }
                ctx.fillText(channel, startX, y);
            });
            
            ctx.restore();
        }

        function drawRitualistAscendantEffects(ctx, width, height, theme, timestamp = 0) {
            ctx.save();
            ctx.globalAlpha = 0.1;
            
            const ranks = [
                { rank: 'RANK', level: 10, xp: '923 / 1.10K XP', progress: 0.84 },
                { rank: 'RANK', level: 8, xp: '645 / 890 XP', progress: 0.72 },
                { rank: 'RANK', level: 15, xp: '1.8K / 2.3K XP', progress: 0.78 },
                { rank: 'RANK', level: 12, xp: '1.2K / 1.6K XP', progress: 0.75 },
                { rank: 'RANK', level: 7, xp: '512 / 720 XP', progress: 0.71 },
                { rank: 'RANK', level: 20, xp: '3.1K / 4.0K XP', progress: 0.78 }
            ];

            const positions = [
                { x: 100, y: 120 },
                { x: 1400, y: 180 },
                { x: 200, y: 480 },
                { x: 1500, y: 540 },
                { x: 800, y: 700 },
                { x: 400, y: 300 }
            ];

            ranks.forEach((rankData, index) => {
                const pos = positions[index];
                
                ctx.font = '32px sans-serif';
                ctx.fillStyle = '#888888';
                ctx.textAlign = 'left';
                ctx.fillText(rankData.rank, pos.x, pos.y);
                
                ctx.font = 'bold 56px sans-serif';
                ctx.fillStyle = theme.textColor;
                ctx.textAlign = 'right';
                ctx.fillText(`LEVEL ${rankData.level}`, pos.x + 550, pos.y + 10);
                
                ctx.font = '28px sans-serif';
                ctx.fillStyle = '#999999';
                ctx.textAlign = 'right';
                ctx.fillText(rankData.xp, pos.x + 550, pos.y + 75);
                
                const barWidth = 460;
                const barHeight = 30;
                const barX = pos.x + 70;
                const barY = pos.y + 95;
                const barRadius = 15;
                
                ctx.fillStyle = '#3A3A3A';
                ctx.beginPath();
                ctx.roundRect(barX, barY, barWidth, barHeight, barRadius);
                ctx.fill();
                
                const fillWidth = barWidth * rankData.progress;
                ctx.fillStyle = theme.titleColor;
                ctx.beginPath();
                ctx.roundRect(barX, barY, fillWidth, barHeight, barRadius);
                ctx.fill();
            });
            
            ctx.restore();
        }

        function drawAvatar(ctx, x, y, radius, avatar, theme) {
            ctx.save();
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.closePath();
            ctx.clip();

            if (avatar) {
                const size = Math.max(avatar.width, avatar.height);
                const scale = (radius * 2) / size;
                const sw = avatar.width;
                const sh = avatar.height;
                const sx = 0;
                const sy = 0;
                const dw = sw * scale;
                const dh = sh * scale;
                const dx = x - dw / 2;
                const dy = y - dh / 2;
                ctx.drawImage(avatar, sx, sy, sw, sh, dx, dy, dw, dh);
            } else {
                ctx.fillStyle = '#2A2D35';
                ctx.fill();
            }

            ctx.restore();

            const ringColor = theme.textColor;
            ctx.strokeStyle = `${ringColor}4D`;
            ctx.lineWidth = 6;
            ctx.beginPath();
            ctx.arc(x, y, radius + 3, 0, Math.PI * 2);
            ctx.stroke();

            ctx.strokeStyle = `${ringColor}33`;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(x, y, radius + 12, 0, Math.PI * 2);
            ctx.stroke();

            ctx.shadowColor = `${ringColor}66`;
            ctx.shadowBlur = 20;
            ctx.strokeStyle = `${ringColor}4D`;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.stroke();
            ctx.shadowBlur = 0;
        }

        function drawRitualLogo(ctx, x, y, size) {
            const img = new Image();
            img.src = ritualLogoImage;
            ctx.globalAlpha = 0.1;
            ctx.drawImage(img, x - size / 2, y - size / 2, size, size);
            ctx.globalAlpha = 1;
        }

        function drawPledgedChip(ctx, x, y, timestamp = 0) {
            const scale = 0.98 + Math.sin(timestamp * 0.001) * 0.02;
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(scale, scale);

            ctx.fillStyle = '#B7FF3C';
            ctx.beginPath();
            ctx.roundRect(-56, -28, 112, 56, 12);
            ctx.fill();

            ctx.fillStyle = '#000';
            ctx.font = 'bold 24px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('PLEDGED', 0, 0);

            ctx.restore();
        }

        function renderCard(ctx, state, theme, timestamp = Date.now()) {
            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height);

            drawPlasmaBackground(ctx, theme, width, height, timestamp);

            if (theme.isNodeRunner) {
                drawNodeRunnerEffects(ctx, width, height, theme, timestamp);
            }

            if (theme.isRitualist) {
                drawRitualistEffects(ctx, width, height, theme, timestamp);
            }

            if (theme.isRitualistAscendant) {
                drawRitualistAscendantEffects(ctx, width, height, theme, timestamp);
            }

            if (theme.isMage && magePixelImg.complete && magePixelImg.naturalWidth > 0) {
                ctx.save();
                ctx.globalCompositeOperation = 'overlay';
                ctx.globalAlpha = 0.6;
                const pattern = ctx.createPattern(magePixelImg, 'repeat');
                ctx.fillStyle = pattern;
                ctx.fillRect(0, 0, width, height);
                ctx.restore();
            }

            applyAuraTint(ctx, theme, width, height);

            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(0, 0, width, height);

            ctx.fillStyle = theme.titleColor;
            ctx.font = 'bold 64px sans-serif';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.fillText('RITUALIST ID CARD', 100, 60);

            if (logoImg.complete && logoImg.naturalWidth > 0) {
                ctx.save();
                ctx.globalCompositeOperation = 'soft-light';
                ctx.globalAlpha = 0.3;
                const logoSize = 280;
                ctx.drawImage(logoImg, width - logoSize - 120, height / 2 - logoSize / 2, logoSize, logoSize);
                ctx.restore();
            }

            const avatarX = 350;
            const avatarY = height / 2;
            const avatarRadius = 140;
            drawAvatar(ctx, avatarX, avatarY, avatarRadius, state.avatar, theme);

            const textX = 650;
            const textY = 200;

            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 96px sans-serif';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.fillText(state.name, textX, textY);

            ctx.fillStyle = '#FFFFFF';
            ctx.font = '42px sans-serif';
            ctx.fillText(`Date of Join  ${state.dateISO}`, textX, textY + 140);

            const roleText = `${state.coreRole} - ${state.auraRole}`;
            ctx.fillStyle = theme.textColor;
            ctx.font = '48px sans-serif';
            ctx.fillText(roleText, textX, textY + 230);

            ctx.fillStyle = theme.textColor;
            ctx.font = '42px sans-serif';
            ctx.fillText('pledged', textX, textY + 300);

            if (state.portfolio) {
                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                ctx.font = '36px sans-serif';
                ctx.fillText(state.portfolio, textX, textY + 370);
            }

            drawPledgedChip(ctx, width - 150, height - 100, timestamp);
        }

        function updateCard() {
            const theme = resolveTheme(state.coreRole, state.auraRole);
            renderCard(ctx, state, theme);
        }

        function loadAvatar(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        resolve(img);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function formatDate(inputValue) {
            return inputValue;
        }

        function downloadCanvasPNG(canvas, filename) {
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            });
        }

        function exportSheet() {
            const sheetCanvas = document.createElement('canvas');
            sheetCanvas.width = 2400;
            sheetCanvas.height = 3600;
            const sheetCtx = sheetCanvas.getContext('2d');

            const auras = ['initiate', 'blessed', 'cursed', 'harmonic'];
            const originalAura = state.auraRole;

            auras.forEach((aura, index) => {
                state.auraRole = aura;
                const theme = resolveTheme(state.coreRole, state.auraRole);
                
                sheetCtx.save();
                sheetCtx.translate(0, index * 900);
                renderCard(sheetCtx, state, theme);
                sheetCtx.restore();
            });

            state.auraRole = originalAura;
            updateCard();

            downloadCanvasPNG(sheetCanvas, 'ritualist-id-card-sheet.png');
        }

        document.getElementById('nameInput').addEventListener('input', (e) => {
            state.name = e.target.value || 'chiefmmorgs';
            updateCard();
        });

        document.getElementById('coreRoleSelect').addEventListener('change', (e) => {
            state.coreRole = e.target.value;
            updateCard();
        });

        document.getElementById('auraRoleSelect').addEventListener('change', (e) => {
            state.auraRole = e.target.value;
            updateCard();
        });

        document.getElementById('portfolioInput').addEventListener('input', (e) => {
            state.portfolio = e.target.value;
            updateCard();
        });

        document.getElementById('dateInput').addEventListener('change', (e) => {
            state.dateISO = formatDate(e.target.value);
            updateCard();
        });

        document.getElementById('photoInput').addEventListener('change', async (e) => {
            if (e.target.files && e.target.files[0]) {
                state.avatar = await loadAvatar(e.target.files[0]);
                updateCard();
            }
        });

        document.getElementById('downloadBtn').addEventListener('click', () => {
            downloadCanvasPNG(canvas, 'ritualist-id-card.png');
        });

        document.getElementById('resetLink').addEventListener('click', (e) => {
            e.preventDefault();
            state.name = 'chiefmmorgs';
            state.coreRole = 'ritualist';
            state.auraRole = 'harmonic';
            state.portfolio = 'Educator';
            state.dateISO = new Date().toISOString().split('T')[0];
            state.avatar = null;

            document.getElementById('nameInput').value = state.name;
            document.getElementById('coreRoleSelect').value = state.coreRole;
            document.getElementById('auraRoleSelect').value = state.auraRole;
            document.getElementById('portfolioInput').value = state.portfolio;
            document.getElementById('dateInput').value = state.dateISO;
            document.getElementById('photoInput').value = '';

            updateCard();
        });

        document.getElementById('exportSheetLink').addEventListener('click', (e) => {
            e.preventDefault();
            exportSheet();
        });

        document.getElementById('dateInput').value = state.dateISO;

        updateCard();

        setInterval(() => {
            const theme = resolveTheme(state.coreRole, state.auraRole);
            renderCard(ctx, state, theme, Date.now());
        }, 50);
    </script>
</body>
</html>
